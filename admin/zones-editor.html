<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CARGOWORKS – Zones Editor (Local)</title>
  <link rel="stylesheet" href="../css/effects/layout.css"/>
  <style>
    .zones-section { padding-top: 2rem; }
    .admin-note { font-family: 'Inter', system-ui, sans-serif; font-size: 0.95rem; color: #333; margin: 1rem 0; }
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="hero-nav">
      <ul class="nav-links">
        <li><a href="../index.html#zones">Back to site</a></li>
      </ul>
    </nav>
  </header>

  <section id="zones" class="zones-section" aria-label="Zone editor">
    <div class="zones-inner">
      <h2>Zones Editor</h2>
      <div class="zones-editor-card">
        <div class="zones-editor-panel">
          <p class="admin-note">Local-only editor. Draw polygons and export to GeoJSON, then replace <code>data/zones.geojson</code> on the site.</p>
          <div class="zones-controls" role="toolbar">
            <button id="zonesEdit" class="btn admin-only" type="button" title="Edit zones">Edit zones</button>
            <button id="zonesExport" class="btn admin-only" type="button" title="Export zones">Export zones</button>
            <button id="zonesImport" class="btn admin-only" type="button" title="Import zones">Import zones</button>
            <input id="zonesImportFile" type="file" accept="application/json,.json" style="display:none" />
            <span id="zoneResult" class="zones-result" aria-live="polite"></span>
          </div>
        </div>
        <div class="zones-editor-map">
          <div id="zonesMap" class="zones-map" aria-label="Interactive zone map"></div>
        </div>
      </div>
    </div>
  </section>

  <footer>
    <span>© 2025 Cargoworks – Zones Editor</span>
  </footer>

  <script>
    // Force edit mode via query param for this page
    (function(){
      if (!location.search.includes('editZones=1')) {
        const qp = new URLSearchParams(location.search);
        qp.set('editZones', '1');
        const url = location.pathname + '?' + qp.toString() + location.hash;
        history.replaceState(null, '', url);
      }
    })();
  </script>
  <script src="../js/js/map.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2-lL3jKtVa6ijgLs38NP2ag6fc4YoAE0&libraries=geometry,drawing&loading=async&callback=initZonesMap"></script>
  <script>
    // After map and editor initialize, auto-start drawing and show a hint
    window.addEventListener('load', function(){
      var editBtn = document.getElementById('zonesEdit');
      var resultEl = document.getElementById('zoneResult');
      var importBtn = document.getElementById('zonesImport');
      var importInput = document.getElementById('zonesImportFile');
      if (resultEl) {
        resultEl.textContent = 'Editing mode enabled: click to draw; double-click to finish; use Import/Export.';
      }
      if (editBtn) {
        try { editBtn.click(); } catch(e) {}
      }

      // Import zones from a local GeoJSON file
      if (importBtn && importInput) {
        importBtn.addEventListener('click', function(){ importInput.click(); });
        importInput.addEventListener('change', function(){
          var file = importInput.files && importInput.files[0];
          if (!file) return;
          var reader = new FileReader();
          reader.onload = function(){
            try {
              var json = JSON.parse(reader.result);
              var count = (window.ZonesEditor && window.ZonesEditor.importGeoJSON) ? window.ZonesEditor.importGeoJSON(json) : 0;
              if (resultEl) resultEl.textContent = 'Imported ' + count + ' zone(s). You can edit and re-export.';
            } catch(e) {
              if (resultEl) resultEl.textContent = 'Failed to import file';
            }
          };
          reader.readAsText(file);
          importInput.value = '';
        });
      }

      // No additional snap controls; keep simple.
    });
  </script>
</body>
</html>
